<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="test-001-create-test-audit-table" author="audit-system-test" context="integration,test">
        <comment>Create Test_PIPELINE_AUDIT_LOG table for Oracle integration testing with Test_ prefix</comment>
        
        <!-- Drop test table if it exists (for clean test runs) -->
        <sql>
            BEGIN
                EXECUTE IMMEDIATE 'DROP TABLE Test_PIPELINE_AUDIT_LOG CASCADE CONSTRAINTS';
            EXCEPTION
                WHEN OTHERS THEN
                    IF SQLCODE != -942 THEN
                        RAISE;
                    END IF;
            END;
        </sql>
        
        <createTable tableName="Test_PIPELINE_AUDIT_LOG" tablespace="USERS">
            <!-- Primary Key -->
            <column name="AUDIT_ID" type="VARCHAR2(36)">
                <constraints primaryKey="true" primaryKeyName="Test_PK_AUDIT_ID" nullable="false"/>
            </column>
            
            <!-- Correlation and System Identification -->
            <column name="CORRELATION_ID" type="VARCHAR2(36)">
                <constraints nullable="false"/>
            </column>
            
            <column name="SOURCE_SYSTEM" type="VARCHAR2(50)">
                <constraints nullable="false"/>
            </column>
            
            <column name="MODULE_NAME" type="VARCHAR2(100)">
                <constraints nullable="true"/>
            </column>
            
            <!-- Process and Entity Information -->
            <column name="PROCESS_NAME" type="VARCHAR2(100)">
                <constraints nullable="true"/>
            </column>
            
            <column name="SOURCE_ENTITY" type="VARCHAR2(200)">
                <constraints nullable="true"/>
            </column>
            
            <column name="DESTINATION_ENTITY" type="VARCHAR2(200)">
                <constraints nullable="true"/>
            </column>
            
            <column name="KEY_IDENTIFIER" type="VARCHAR2(100)">
                <constraints nullable="true"/>
            </column>
            
            <!-- Checkpoint and Status Information -->
            <column name="CHECKPOINT_STAGE" type="VARCHAR2(50)">
                <constraints nullable="false"/>
            </column>
            
            <column name="STATUS" type="VARCHAR2(20)">
                <constraints nullable="false"/>
            </column>
            
            <!-- Timestamp and Message -->
            <column name="EVENT_TIMESTAMP" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            
            <column name="MESSAGE" type="VARCHAR2(1000)">
                <constraints nullable="true"/>
            </column>
            
            <!-- JSON Details for Metadata -->
            <column name="DETAILS_JSON" type="CLOB">
                <constraints nullable="true"/>
            </column>
        </createTable>
        
        <!-- Add constraints for enum values with Test_ prefix -->
        <addCheckConstraint tableName="Test_PIPELINE_AUDIT_LOG" 
                           constraintName="Test_CHK_AUDIT_STATUS"
                           checkCondition="STATUS IN ('SUCCESS', 'FAILURE', 'WARNING')"/>
        
        <addCheckConstraint tableName="Test_PIPELINE_AUDIT_LOG" 
                           constraintName="Test_CHK_CHECKPOINT_STAGE"
                           checkCondition="CHECKPOINT_STAGE IN ('RHEL_LANDING', 'SQLLOADER_START', 'SQLLOADER_COMPLETE', 'LOGIC_APPLIED', 'FILE_GENERATED')"/>
        
        <!-- Add Oracle-specific table comments for testing documentation -->
        <setTableRemarks tableName="Test_PIPELINE_AUDIT_LOG" 
                        remarks="Test audit trail table for Oracle integration testing with Test_ prefix for isolation"/>
        
        <setColumnRemarks tableName="Test_PIPELINE_AUDIT_LOG" columnName="AUDIT_ID" 
                         remarks="Test: Unique identifier for each audit event (UUID format)"/>
        
        <setColumnRemarks tableName="Test_PIPELINE_AUDIT_LOG" columnName="CORRELATION_ID" 
                         remarks="Test: Links related audit events across pipeline stages (UUID format)"/>
        
        <setColumnRemarks tableName="Test_PIPELINE_AUDIT_LOG" columnName="SOURCE_SYSTEM" 
                         remarks="Test: Identifier for the source system generating the data"/>
        
        <setColumnRemarks tableName="Test_PIPELINE_AUDIT_LOG" columnName="DETAILS_JSON" 
                         remarks="Test: JSON metadata stored as Oracle CLOB for large data testing"/>
        
    </changeSet>

</databaseChangeLog>